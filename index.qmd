---
title: "Project"
author: "Roberto_Antuna"
subtitle: "Investigation into Chicago taxis"
format:
  html:
    code-fold: true
    echo: true
bibliography: references.bib
---

## Introduction

This report presents an exploratory data analysis (EDA) of Chicago `taxi` data. Leveraging the *Tidyverse* ecosystem and *Tidymodels* in R, the analysis focuses on **visualizing** and **quantifying** key factors that influence tipping, such as trip distance and company performance.

<img src="images/taxi.png" align="right" width="300" height="180"/>

## Packages

```{r}
#| label: load-packages
#| warning: false
#| message: false
library(tidyverse)
library(tidymodels)
library(scales)
library(skimr)
```

### Data

The dataset we will visualize is called `taxi`. Let's `glimpse()` at it.

```{r}
#| label: load-data
#Load data
data(taxi)
glimpse(taxi)

```

## Description

The data used in this report comprises a subset of taxi trips recorded in the city of Chicago during 2022. The dataset includes information on trip duration, location, and payment details, allowing for an analysis of factors influencing tipping behavior.

Key variables include trip distance, the specific taxi company, and temporal data (hour, day, month).

### Data Dictionary

| Variable | Description |
|:-----------------------|:-----------------------------------------------|
| `tip` | Whether the rider left a tip. A factor with levels "yes" and "no". |
| `distance` | The trip distance, in odometer miles. |
| `company` | The taxi company, as a factor. Companies with low frequency were binned as "other". |
| `local` | Whether the trip's starting and ending locations are in the same community. |
| `dow` | The day of the week in which the trip began (Factor). |
| `month` | The month in which the trip began (Factor). |
| `hour` | The hour of the day in which the trip began (Numeric). |

## General Data Overview

Before diving into specific questions, let's examine the structure and integrity of the dataset.

```{r}
#| label: data-skim
#| echo: true

# Complete summary of statistics and null values
skim_without_charts(taxi)

```

The summary statistics above reveal a clean and well-structured dataset with **zero missing values** across all variables, ensuring that no imputation is required for this analysis.

Key observations include:

-   **Tipping Behavior:** The target variable `tip` is highly unbalanced, with the vast majority of passengers (9,209 out of 10,000) opting to leave a tip.
-   **Trip Distance:** The distance variable shows a strong right skew. While the average trip is approximately 6.22 miles, the median is much lower at 1.78 miles, indicating that most taxi rides are short. The high sd (7.38), which exceeds the mean, further confirms the presence of extreme outliers pulling the average up.
-   **Companies:** The `company` variable has a significant number of observations categorized as "other" (2,715), suggesting a fragmented market with many smaller operators alongside major ones like Sun Taxi and Taxi Affiliation Services.

```{r}
#|label: tip-col_chart
#| echo: true
# Bar chart to see the proportion of tips
taxi|>
  count(tip) |>
  mutate(
    percentage = n / sum(n),
    label = scales::percent(percentage, accuracy = 0.1)
  ) |>
  ggplot(aes(x = tip, y = n, fill = tip)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = label), vjust = -0.5, fontface = "bold") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(labels = str_to_title) +
  scale_fill_manual(values = c("steelblue", "gray70")) +
  labs(
    title = "Distribution of Tipping Behavior",
    subtitle = "Tipping is the overwhelming norm (92.1%)",
    x = "Did the passenger tip?",
    y = "Count of Trips",
    caption = "Data: City of Chicago 2022 (via modeldata R package)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
#| label: distance-distribution
#| echo: true
#| warning: false
# Histogram with logarithmic scale to handle bias
ggplot(taxi, aes(x = distance)) +
  geom_histogram(bins = 30, fill = "midnightblue", color = "white", alpha = 0.8) +
  scale_x_log10(labels = scales::label_number(suffix = " mi")) +
  labs(
    title = "Distribution of Trip Distances",
    subtitle = "Most trips are short (under 2 miles), with a long tail of outliers",
    x = "Distance (Log Scale)",
    y = "Frequency",
    caption = "Data: City of Chicago 2022 (via modeldata R package)"
  ) +
  theme_minimal()
```

## Question 1

Is there there a relationship between the distance (in miles) someone travels in a taxi and if they tip or not?

```{r}
#| label: question-1-analysis
#| echo: true

# 1. Boxplot
ggplot(taxi, aes(x = tip, y = distance, fill = tip)) +
  geom_boxplot(alpha = 0.8, outlier.size = 1) +
  scale_y_continuous(
    labels = scales::label_number(suffix = " mi"),
    breaks = seq(0, 50, 5)
  ) +
  scale_x_discrete(labels = str_to_title) +
  scale_fill_manual(values = c("steelblue", "gray70")) +
  labs(
    title = "Relationship between Trip Distance and Tipping",
    subtitle = "Trips with tips tend to be slightly longer on average",
    x = "Did the passenger tip?",
    y = "Trip Distance",
    caption = "Data: City of Chicago 2022 (via modeldata R package)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank()
  )

# 2. Data Evidence
taxi |>
  group_by(tip) |> 
  summarise(
    count = n(),
    avg_dist = mean(distance, na.rm = TRUE),
    p25_dist = quantile(distance, 0.25, na.rm = TRUE),
    median_dist = median(distance, na.rm = TRUE),
    p75_dist = quantile(distance, 0.75, na.rm = TRUE)
  ) |> 
  knitr::kable(
    col.names = c("Tip?", "Total Trips", "Mean Dist", "25th %", "Median", "75th %"),
    digits = 2,
    align = "c",
    caption = "Distance Statistics by Tipping Status"
  )
```

**Analysis:**

The data reveals a clear behavioral split based on trip length:

1.  **Short Trips (Under 2 miles):** Tipping behavior is unpredictable. The median distance for both groups is nearly identical (\~1.7 miles), meaning distance is not a strong deciding factor for short hops.
2.  **Long Trips (\> 6 miles):** The probability of receiving a tip increases significantly with distance.
    -   The summary table shows that **75% of non-tipped trips are shorter than 6.26 miles**.
    -   In contrast, tipped trips frequently extend much further (75th percentile is **16.4 miles**).

**Conclusion:** 
While short trips are a toss-up, long-distance passengers are consistently more reliable tippers. Drivers accepting long fares face a much lower risk of not being tipped.

## Question 2

Do taxi passengers tend to tip more for the company Chicago Independents than the other companies?

```{r}
#| label: question-2-analysis
#| echo: true

# 1. Data prep
company_analysis <- taxi |> 
  group_by(company) |> 
  summarise(
    total_trips = n(),
    tipped_trips = sum(tip == "yes"),
    tip_rate = tipped_trips / total_trips
  ) |> 
  mutate(company = fct_reorder(company, tip_rate))

# 2. Visualization
ggplot(company_analysis, aes(x = tip_rate, y = company, fill = company == "Chicago Independents")) +
  geom_col() +
  geom_text(aes(label = scales::percent(tip_rate, accuracy = 0.1)), 
            hjust = -0.1, size = 3.5, fontface = "bold") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1.1),
                     breaks = seq(0, 1, 0.2)
                     ) + 
  scale_fill_manual(values = c("gray70", "steelblue")) + 
  labs(
    title = "Tipping Probability by Company",
    subtitle = "Chicago Independents leads the market; Flash Cab lags significantly behind",
    x = "Percentage of Trips with Tip",
    y = NULL,
    caption = "Data: City of Chicago 2022 (via modeldata R package)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.y = element_blank()
  )

# 3. Summary
company_analysis |> 
  arrange(desc(tip_rate)) |> 
  knitr::kable(
    col.names = c("Company", "Total Trips", "Tipped Trips", "Tip Rate"),
    digits = 3,
    align = "lccc",
    caption = "Tip Rates by Company Provider"
  )
```

**Analysis:**

When comparing "Chicago Independents" against the aggregate of all other companies, the data supports the hypothesis: Independents have a tipping rate of **94.9%** versus an average of **91.8%** for the rest.

However, a granular analysis reveals a more nuanced competitive landscape:

-   **Market Leader:** "Chicago Independents" is indeed the top performer.
-   **Close Competitors:** Companies like "Sun Taxi" (93.9%) and "City Service" (92.7%) trail by a very narrow margin, suggesting high service standards across most major providers.
-   **The Real Driver:** The significant gap in the "all other companies" group is largely driven by **Flash Cab**, which under-performs significantly with an **86.9%** tip rate. Without Flash Cab, the difference between Independents and the rest would be negligible.

**Conclusion:**
There is some to little evidence that the specific company brand drives tipping behavior. While "Chicago Independents" statistically leads the pack, the difference is marginal (~3%) and largely explained by the underperformance of a single competitor (Flash Cab) rather than a unique advantage of the leader.

## Question 3

Does the time of day affect the likelihood of a passenger leaving a tip?

```{r}
#| label: question-3-analysis
#| echo: true

# 1. Data Prep
hourly_analysis <- taxi |> 
  group_by(hour) |> 
  summarise(
    total_trips = n(),
    tip_rate = sum(tip == "yes") / n()
  )
global_rate <- mean(taxi$tip == "yes")

# 2. Visualization
ggplot(hourly_analysis, aes(x = hour, y = tip_rate)) +
  geom_hline(yintercept = global_rate, linetype = "dashed", color = "gray40") +
  annotate("text", x = 2.5, y = global_rate+0.005, label = paste("Avg:", percent(global_rate, 0.1)),
           color = "gray40", size = 3) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_point(color = "steelblue", size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0.85, 1)) +
  scale_x_continuous(breaks = seq(1, 23, 2)) +
  labs(
    title = "Hourly Tipping Trends",
    subtitle = "Perfect tipping rates observed in early morning (2-4 AM), likely due to very low trip volume",
    x = "Hour of Day (24h format)",
    y = "Tip Rate",
    caption = "Data: City of Chicago 2022"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank()
  )

# 3. Summary
hourly_analysis |> 
  arrange(desc(tip_rate)) |> 
  slice(1:5) |> 
  knitr::kable(
    col.names = c("Hour", "Total Trips", "Tip Rate"),
    digits = 3,
    align = "ccc",
    caption = "Top Performing Hours (Note the low Total Trips)"
  )
```

**Analysis:**

The temporal analysis reveals unexpected insights regarding early morning trips:

-   **The Early Morning Anomaly:** Surprisingly, the data shows a perfect tipping rate (**100%**) around **02:00 - 04:00 AM**.

    -   *Analyst Note:* This extreme value is driven by a significantly **lower volume of trips** (e.g., only 8-13 trips per hour), making the metric highly volatile compared to the busy daytime hours.

-   **Stability during Business Hours:** From 08:00 to 18:00, the tipping rate stabilizes near the global average (\~92%), representing the most reliable period for drivers due to high passenger volume(\>600 trips/hour).

**Conclusion:**
Time of day is **not a strong predictor** of whether a passenger will tip or not. Aside from statistical anomalies in the early morning due to small sample sizes, tipping behavior remains remarkably consistent (between 90% and 93%) throughout the entire day.

## Bonus Chapter

